FROM python:3.10-slim

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    python3-dev \
    curl \
    gnupg \
    lsb-release \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install Nuclei
RUN curl -s https://api.github.com/repos/projectdiscovery/nuclei/releases/latest | \
    grep "browser_download_url.*linux_amd64.zip" | \
    cut -d : -f 2,3 | \
    tr -d \" | \
    wget -qi - && \
    unzip nuclei_*_linux_amd64.zip && \
    mv nuclei /usr/local/bin/ && \
    rm nuclei_*_linux_amd64.zip

# Create and use a non-root user
RUN groupadd -r cyberops && useradd -r -g cyberops cyberops
RUN mkdir -p /home/cyberops/app /home/cyberops/.nuclei-templates
RUN chown -R cyberops:cyberops /home/cyberops

# Set the working directory
WORKDIR /home/cyberops/app

# Copy requirements first to leverage Docker caching
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install additional dependencies
RUN pip install --no-cache-dir aiohttp aiofiles aiodns asyncio cvss psycopg2-binary

# Download Nuclei templates
RUN nuclei -update-templates -silent && \
    cp -r /root/nuclei-templates/* /home/cyberops/.nuclei-templates/ && \
    chown -R cyberops:cyberops /home/cyberops/.nuclei-templates

# Copy the application code
COPY --chown=cyberops:cyberops . .

# Switch to non-root user
USER cyberops

# Set environment variables for Nuclei
ENV NUCLEI_TEMPLATES_PATH=/home/cyberops/.nuclei-templates

# Command to run
CMD ["python", "-m", "modules.vulnerability.scanner"]