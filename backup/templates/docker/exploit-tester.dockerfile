FROM ubuntu:22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV MSF_ROOT=/usr/share/metasploit-framework
ENV PATH=$PATH:$MSF_ROOT

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    libpq-dev \
    libpcap-dev \
    libsqlite3-dev \
    python3 \
    python3-pip \
    python3-dev \
    ruby \
    ruby-dev \
    nmap \
    curl \
    wget \
    gnupg2 \
    netcat \
    && rm -rf /var/lib/apt/lists/*

# Install Metasploit Framework
RUN curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && \
    chmod 755 msfinstall && \
    ./msfinstall && \
    rm msfinstall

# Configure MSF to use the PostgreSQL database
RUN mkdir -p /root/.msf4
RUN echo 'production:\n adapter: postgresql\n database: msf\n username: msf\n password: msf\n host: postgres\n port: 5432\n pool: 75\n timeout: 5' > /root/.msf4/database.yml

# Install Python dependencies
RUN pip3 install --no-cache-dir psycopg2-binary requests msgpack jinja2

# Create and use a non-root user
RUN groupadd -r cyberops && useradd -m -r -g cyberops cyberops
RUN mkdir -p /home/cyberops/app
WORKDIR /home/cyberops/app

# Copy Python application
COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

# Add exploits directory and templates
RUN mkdir -p /home/cyberops/app/modules/vulnerability/exploiter/exploits
RUN mkdir -p /home/cyberops/app/modules/vulnerability/exploiter/templates
RUN mkdir -p /home/cyberops/app/modules/vulnerability/exploiter/reports

# Copy the application code
COPY . .

# Start MSF RPC server and run the application
CMD ["bash", "-c", "msfrpcd -U msf -P msf -a 127.0.0.1 -p 55553 -S && python3 -m modules.vulnerability.exploiter"]